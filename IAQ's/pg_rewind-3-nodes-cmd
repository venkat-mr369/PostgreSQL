 **3-node HA cluster** (Node1 = Primary, Node2 & Node3 = Standbys).
This is very common in **Patroni / Streaming replication** clusters.

---

# ğŸŒ³ PostgreSQL HA with `pg_rewind` (3 Nodes)

---

### **Step 1: Normal Operation**

```
                   WAL Streaming
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   =========>   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Node1       â”‚                â”‚   Node2       â”‚
 â”‚   Primary     â”‚   =========>   â”‚   Standby     â”‚
 â”‚ (10.0.0.1)    â”‚   WAL Streamingâ”‚ (10.0.0.2)    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         =========>
                         WAL Streaming
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚   Node3       â”‚
                         â”‚   Standby     â”‚
                         â”‚ (10.0.0.3)    â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… Node1 writes â†’ Node2 & Node3 replicate WAL.

---

### **Step 2: Failover (Node1 Crashes)**

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Node1       â”‚
 â”‚   Crashed     â”‚
 â”‚ Diverged WAL  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

 Promote Node2
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Node2       â”‚   =========>   â”‚   Node3       â”‚
 â”‚   NEW Primary â”‚   WAL Streamingâ”‚   Standby     â”‚
 â”‚ (10.0.0.2)    â”‚                â”‚ (10.0.0.3)    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… Node2 is promoted â†’ new Primary.
âœ… Node3 keeps following Node2.
âŒ Node1 is out of sync (diverged WAL).

---

### **Step 3: Rewind Old Primary (Node1)**

On Node1:

```bash
pg_ctl stop -D /var/lib/pgsql/17/data

pg_rewind \
  --target-pgdata=/var/lib/pgsql/17/data \
  --source-server="host=10.0.0.2 dbname=postgres user=replicator password=xxx"

pg_ctl start -D /var/lib/pgsql/17/data
```

âœ… Node1 is now rewound using Node2â€™s state.

---

### **Step 4: Node1 Rejoins as Standby**

```
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Node2       â”‚   =========>   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   Primary     â”‚   WAL Streamingâ”‚   Node1       â”‚
 â”‚ (10.0.0.2)    â”‚   =========>   â”‚   Standby     â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚ (10.0.0.1)    â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Node3       â”‚
                â”‚   Standby     â”‚
                â”‚ (10.0.0.3)    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

âœ… Cluster is healthy: Node2 = Primary, Node1 + Node3 = Standbys.

---

# ğŸ”‘ Extensions After Migration (14 â†’ 17)

On **all 3 nodes**:

1. Install contrib packages:

   ```bash
   sudo dnf install -y postgresql17-contrib
   ```
2. Recreate extension in the migrated DB:

   ```sql
   CREATE EXTENSION pg_stat_statements;
   CREATE EXTENSION pgcrypto;
   ```

âœ… Ensures extension availability across cluster.

---

# ğŸ§  Interview-Ready Answer

> â€œIn a 3-node HA setup, say Node1 is primary and Node2/Node3 are standbys. If Node1 crashes and Node2 is promoted, Node1 diverges. Instead of recloning Node1, I run `pg_rewind` pointing it to Node2, which rewinds only the differences. Node1 then rejoins as standby. After a major version migration (14 â†’ 17), I also make sure contrib packages are installed on all nodes and recreate extensions like `pg_stat_statements` so that cluster-wide consistency is maintained.â€

---
